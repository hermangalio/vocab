{% extends "base.html" %}
{% block title %}Calibrate â€” {{ word_list.name }}{% endblock %}

{% block content %}
<div id="calibration-area" style="max-width: 550px; margin: 0 auto; text-align: center;">

    <!-- Intro -->
    <div id="intro">
        <h1>Calibrate Your Level</h1>
        <p><strong>{{ word_list.name }}</strong></p>
        <p>We'll show you {{ words | length }} words from this document, common to rare. For each one, tell us if you <strong>confidently know what it means</strong>.</p>
        <p>This determines which words from this document to quiz you on.</p>
        <button id="start-btn">Start</button>
        <details style="margin-top: 1.5rem; text-align: left;">
            <summary><small>Or set a custom threshold</small></summary>
            <form id="custom-form" style="margin-top: 0.5rem;">
                <label>Zipf threshold <small>(lower = rarer words included)</small>
                    <input type="number" id="custom-threshold" step="0.1" min="0.5" max="7.0" value="3.0" required>
                </label>
                <button type="submit" class="outline">Set Threshold</button>
            </form>
        </details>
    </div>

    <!-- Word card -->
    <div id="word-card" style="display:none;">
        <p><small id="progress"></small></p>
        <progress id="progress-bar" value="0" max="{{ words | length }}" style="width:100%;"></progress>
        <h2 style="margin: 2rem 0;"><mark id="cal-word"></mark></h2>
        <p>Do you know what this word means?</p>
        <div class="grid">
            <button id="yes-btn" class="outline">Yes, I know it</button>
            <button id="no-btn" class="outline secondary">No / Not sure</button>
        </div>
    </div>

    <!-- Result -->
    <div id="result" style="display:none;">
        <h2>Calibration Complete</h2>
        <p>Your threshold for this document has been set. Words at or below this rarity level will be included in quizzes.</p>
        <a href="{{ url_for('word_list', list_id=word_list.id) }}" role="button" style="margin-top: 1rem;">View Word List</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const words = {{ words | tojson }};
    const listId = {{ word_list.id }};
    let current = 0;
    const answers = [];

    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('intro').style.display = 'none';
        document.getElementById('word-card').style.display = 'block';
        showWord();
    });

    function showWord() {
        document.getElementById('cal-word').textContent = words[current].word.toUpperCase();
        document.getElementById('progress').textContent = `Word ${current + 1} of ${words.length}`;
        document.getElementById('progress-bar').value = current;
    }

    function answer(known) {
        answers.push(known);
        current++;
        if (current < words.length) {
            showWord();
        } else {
            document.getElementById('progress-bar').value = words.length;
            submitCalibration();
        }
    }

    document.getElementById('yes-btn').addEventListener('click', () => answer(true));
    document.getElementById('no-btn').addEventListener('click', () => answer(false));

    async function submitCalibration() {
        document.getElementById('word-card').style.display = 'none';

        const res = await fetch(`/words/${listId}/calibrate/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answers }),
        });
        const data = await res.json();
        document.getElementById('result').style.display = 'block';
    }

    document.getElementById('custom-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const threshold = parseFloat(document.getElementById('custom-threshold').value);
        const res = await fetch(`/words/${listId}/calibrate/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ custom_threshold: threshold }),
        });
        const data = await res.json();
        document.getElementById('intro').style.display = 'none';
        document.getElementById('result').style.display = 'block';
    });
</script>
{% endblock %}
